<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monthly Money — LKR/USD Tracker (v2)</title>
  <style>
    :root{
      --bg:#0b0f1a; --panel:#12182a; --panel-2:#0f1424; --text:#eff6ff; --muted:#94a3b8;
      --accent:#34d399; --accent-2:#60a5fa; --danger:#ef4444; --border:#1e293b; --inset:#0a0f1c;
      --shadow: 0 10px 25px rgba(0,0,0,.35); --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 700px at 10% -10%, #1a2240 0%, transparent 50%),
                  radial-gradient(1200px 800px at 110% -20%, #1b293e 0%, transparent 50%), var(--bg);
      color:var(--text)}
    header{padding:18px 20px; position:sticky; top:0; z-index:50; backdrop-filter:blur(8px);
      background: linear-gradient(180deg, rgba(11,15,26,.85), rgba(11,15,26,.65)); border-bottom:1px solid var(--border)}
    .brand{display:flex; align-items:center; gap:12px}
    .logo{width:40px; height:40px; border-radius:12px; background:linear-gradient(145deg, var(--accent), var(--accent-2)); box-shadow:var(--shadow)}
    .title{font-weight:800; letter-spacing:.5px; font-size:20px}
    .subtitle{color:var(--muted); font-size:12px}
    .header-row{display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:14px}
    .controls{display:flex; flex-wrap:wrap; align-items:center; gap:10px}
    .chip{display:inline-flex; align-items:center; gap:10px; padding:10px 12px; border-radius:999px; background:#1f2942; border:1px solid var(--border)}
    .chip input[type="month"], .chip select {background:transparent; border:none; color:var(--text)}
    .chip input:focus, .chip select:focus{outline:none}
    .btn{cursor:pointer; border:none; padding:12px 16px; border-radius:999px; background:linear-gradient(145deg, var(--accent), #16a34a); color:#032013; font-weight:800; letter-spacing:.3px; box-shadow:var(--shadow)}
    .btn.secondary{background:linear-gradient(145deg, #1f2937, #0f172a); color:var(--text); border:1px solid var(--border)}
    .btn.ghost{background:transparent; color:var(--text); border:1px solid var(--border)}

    nav.tabs{display:flex; gap:10px; padding:12px 20px}
    nav.tabs button{background:var(--panel); border:1px solid var(--border); color:var(--text); padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:700}
    nav.tabs button.active{background:linear-gradient(145deg,#1f2a46,#12182a); border-color:#2b3a59}

    main{padding: 6px 20px 80px}
    .grid{display:grid; grid-template-columns: 1.2fr 1fr; gap:16px}
    @media (max-width: 1100px){ .grid{grid-template-columns:1fr} }

    .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)); border:1px solid var(--border); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow)}
    .card h3{margin:0 0 10px 0; font-size:18px}
    .muted{color:var(--muted)}

    .kpis{display:grid; grid-template-columns: repeat(4, 1fr); gap:12px}
    @media (max-width:900px){ .kpis{grid-template-columns:repeat(2,1fr)} }
    .kpi{padding:16px; border-radius:16px; background:var(--panel); border:1px solid var(--border)}
    .kpi .label{font-size:12px; color:var(--muted)}
    .kpi .value{font-size:22px; font-weight:900; margin-top:6px}

    .progress{height:14px; width:100%; background:var(--inset); border:1px solid var(--border); border-radius:999px; overflow:hidden}
    .bar{height:100%; width:0; background:linear-gradient(90deg, #22c55e, #84cc16, #f59e0b, #ef4444); transition:width .35s ease}
    .cc-caption{display:flex; justify-content:space-between; font-size:12px; color:var(--muted)}

    .two-col{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:900px){ .two-col{grid-template-columns:1fr} }

    form .row{display:grid; grid-template-columns: repeat(2, 1fr); gap:12px}
    @media (max-width:700px){ form .row{grid-template-columns:1fr} }
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input, select, textarea{width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:#0f1424; color:var(--text)}

    table{width:100%; border-collapse:separate; border-spacing:0 8px}
    thead th{font-size:12px; color:var(--muted); text-align:left; padding:0 12px}
    tbody td{background:var(--panel); border:1px solid var(--border); padding:12px; vertical-align:middle}
    tbody tr td:first-child{border-radius:12px 0 0 12px}
    tbody tr td:last-child{border-radius:0 12px 12px 0}

    .pill{padding:6px 10px; border-radius:999px; font-weight:800; font-size:12px; letter-spacing:.3px; display:inline-block}
    .pill.expense{background:rgba(239,68,68,.15); color:#fecaca; border:1px solid rgba(239,68,68,.25)}
    .pill.earning{background:rgba(34,197,94,.15); color:#bbf7d0; border:1px solid rgba(34,197,94,.25)}

    .legend{display:flex; flex-wrap:wrap; gap:8px}
    .legend .item{display:flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--border); border-radius:10px; background:#0f1424}
    .swatch{width:10px; height:10px; border-radius:3px}

    /* donut */
    .donut-wrap{display:grid; grid-template-columns: 170px 1fr; align-items:center; gap:18px}
    @media (max-width:700px){ .donut-wrap{grid-template-columns:1fr} }
    .donut{width:160px; height:160px; border-radius:50%; position:relative; background:conic-gradient(#1f2937 0 100%)}
    .donut::after{content:""; position:absolute; inset:24px; background:#0f1424; border-radius:50%; border:1px solid var(--border)}
    .donut-center{position:absolute; inset:0; display:grid; place-items:center; font-weight:900}

    .footer-note{color:var(--muted); font-size:12px; margin-top:8px}
    .stack{display:flex; flex-wrap:wrap; gap:10px}
    .hidden{display:none!important}

    /* comparison chart */
    .chart-wrap{width:100%; height:320px; border:1px solid var(--border); border-radius:16px; background:var(--panel); margin-top:12px; overflow:hidden}
    .tick{font-size:12px; fill:var(--muted)}
    .bar-earn{fill:#60a5fa}
    .bar-exp{fill:#34d399}
    .line-net{fill:none; stroke:#f59e0b; stroke-width:2}
    .grid-line{stroke:#1f2937; stroke-width:1}
  </style>
</head>
<body>
  <header>
    <div class="header-row">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">Monthly Money</div>
          <div class="subtitle">LKR expenses · USD/LKR earnings · credit card utilization</div>
        </div>
      </div>
      <div class="controls">
        <div class="chip">
          <span class="muted">Month</span>
          <input id="monthPicker" type="month" />
        </div>
        <button id="exportBtn" class="btn secondary">Export JSON</button>
        <label class="btn ghost" for="importFile" style="cursor:pointer">Import JSON</label>
        <input id="importFile" type="file" accept="application/json" class="hidden" />
      </div>
    </div>
  </header>

  <nav class="tabs">
    <button data-tab="dashboard" class="active">Dashboard</button>
    <button data-tab="add">Add Entry</button>
    <button data-tab="list">Transactions</button>
    <button data-tab="compare">Compare</button>
    <button data-tab="settings">Settings</button>
  </nav>

  <main>
    <section id="dashboard" class="tab-panel">
      <div class="kpis">
        <div class="kpi"><div class="label">Earnings (LKR)</div><div id="kpiEarnings" class="value">—</div></div>
        <div class="kpi"><div class="label">Expenses (LKR)</div><div id="kpiExpenses" class="value">—</div></div>
        <div class="kpi"><div class="label">Net (E − X)</div><div id="kpiNet" class="value">—</div></div>
        <div class="kpi">
          <div class="label">Credit Card Utilization</div>
          <div class="progress"><div id="ccBar" class="bar"></div></div>
          <div class="cc-caption"><span id="ccSpendLbl">—</span><span id="ccLimitLbl">—</span></div>
        </div>
      </div>

      <div class="two-col" style="margin-top:14px">
        <div class="card">
          <h3>Category Breakdown (Expenses)</h3>
          <div class="donut-wrap">
            <div class="donut" id="donut"><div class="donut-center" id="donutCenter">—</div></div>
            <div>
              <div id="legend" class="legend"></div>
              <div class="footer-note">Shows only expenses in the selected month. Percentages are based on LKR totals.</div>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>Recent Transactions</h3>
          <div id="recent" class="stack"></div>
        </div>
      </div>
    </section>

    <section id="add" class="tab-panel hidden">
      <div class="grid">
        <div class="card">
          <h3>Add Expense</h3>
          <form id="expenseForm">
            <div class="row">
              <div><label>Amount (LKR)</label><input type="number" min="0" step="0.01" id="exAmount" required /></div>
              <div><label>Date</label><input type="date" id="exDate" required /></div>
            </div>
            <div class="row">
              <div><label>Category</label><select id="exCategory"></select></div>
              <div><label>Payment Method</label><select id="exMethod"><option>Credit Card</option><option>Cash</option><option>Bank Transfer</option></select></div>
            </div>
            <div class="row">
              <div><label>Note (optional)</label><input id="exNote" placeholder="e.g., lunch at Keells" /></div>
            </div>
            <div class="row"><div><button class="btn" type="submit">Add Expense</button></div></div>
          </form>
        </div>
        <div class="card">
          <h3>Add Earning</h3>
          <form id="earningForm">
            <div class="row">
              <div><label>Amount</label><input type="number" min="0" step="0.01" id="erAmount" required /></div>
              <div><label>Currency</label><select id="erCurrency"><option value="USD">USD</option><option value="LKR">LKR</option></select></div>
            </div>
            <div class="row">
              <div><label>Source</label><select id="erSource"><option>Salary</option><option>Freelance</option><option>Other</option></select></div>
              <div><label>Date</label><input type="date" id="erDate" required /></div>
            </div>
            <div class="row"><div><label>Note (optional)</label><input id="erNote" placeholder="e.g., YouTube payout" /></div></div>
            <div class="row"><div class="muted">USD amounts convert using your current rate in <b>Settings</b>. The rate is recorded per entry so historical months don’t change when you update it.</div></div>
            <div class="row"><div><button class="btn" type="submit">Add Earning</button></div></div>
          </form>
        </div>
      </div>
    </section>

    <section id="list" class="tab-panel hidden">
      <div class="card">
        <div class="row">
          <div><label>Search</label><input id="searchBox" placeholder="Find by note, category, source, method…" /></div>
          <div><label>Filter Type</label><select id="typeFilter"><option value="all">All</option><option value="expense">Expense</option><option value="earning">Earning</option></select></div>
        </div>
        <div style="overflow:auto; margin-top:12px">
          <table>
            <thead><tr><th>Date</th><th>Type</th><th>Category / Source</th><th>Amount (LKR)</th><th>Original</th><th>Method</th><th>Note</th><th>Actions</th></tr></thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="compare" class="tab-panel hidden">
      <div class="card">
        <h3>Month‑over‑Month (Earnings vs Expenses)</h3>
        <div class="row"><div>
          <label>Show Last</label>
          <select id="cmpMonths"><option value="3">3 months</option><option value="6" selected>6 months</option><option value="12">12 months</option><option value="24">24 months</option></select>
        </div></div>
        <div class="chart-wrap"><svg id="cmpChart" viewBox="0 0 900 320" preserveAspectRatio="none"></svg></div>
        <div class="legend" id="cmpLegend" style="margin-top:10px"></div>
      </div>
      <div class="card">
        <h3>Monthly Summary</h3>
        <div style="overflow:auto; margin-top:12px">
          <table>
            <thead><tr><th>Month</th><th>Earnings (LKR)</th><th>Expenses (LKR)</th><th>Net</th><th>CC Spend</th></tr></thead>
            <tbody id="cmpTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="settings" class="tab-panel hidden">
      <div class="two-col">
        <div class="card">
          <h3>Currency & Limits</h3>
          <form id="settingsForm">
            <div class="row">
              <div><label>USD ➜ LKR Rate</label><input id="usdRate" type="number" step="0.01" min="0" /></div>
              <div><label>Credit Card Limit (LKR)</label><input id="ccLimit" type="number" step="1" min="0" /></div>
            </div>
            <div class="row"><div><button class="btn" type="submit">Save Settings</button> <button id="resetData" class="btn ghost" type="button">Reset All Data</button></div></div>
            <div class="footer-note">Default limit is set to LKR 225,000 based on your note. You can change it anytime.</div>
          </form>
        </div>
        <div class="card">
          <h3>Data Backup</h3>
          <p class="muted">Your data is stored locally in this browser using LocalStorage — private and offline. Use Export/Import to back up or move devices.</p>
          <div class="stack">
            <button id="exportBtn2" class="btn secondary">Export JSON</button>
            <label class="btn ghost" for="importFile2" style="cursor:pointer">Import JSON</label>
            <input id="importFile2" type="file" accept="application/json" class="hidden" />
          </div>
        </div>
      </div>
    </section>
  </main>

  <template id="recentItemTpl">
    <div class="card" style="padding:12px; margin:0;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
        <div style="display:flex; align-items:center; gap:10px">
          <span class="pill"></span>
          <div>
            <div class="muted" data-date></div>
            <div style="font-weight:800" data-title></div>
          </div>
        </div>
        <div style="font-weight:900" data-amount></div>
      </div>
    </div>
  </template>

  <script>
    // ------------------ Data & Storage ------------------
    const STORAGE_KEY = 'monthly_money_v2';
    const DEFAULTS = { settings: { usdLkrRate: 325, ccLimit: 225000 }, transactions: [] };
    const CATEGORIES = ['Food & Groceries','Transport','Bills & Utilities','Shopping','Health','Entertainment','Education','Travel','Subscriptions','Gifts','Other'];
    const COLORS = ['#34d399','#60a5fa','#f43f5e','#f59e0b','#a78bfa','#22d3ee','#84cc16','#fb7185','#c084fc','#06b6d4','#eab308'];

    const state = load();
    function load(){ const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return JSON.parse(JSON.stringify(DEFAULTS)); try{ return JSON.parse(raw);}catch{ return JSON.parse(JSON.stringify(DEFAULTS)); } }
    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    // ------------------ Utilities ------------------
    const fmtLKR = new Intl.NumberFormat('en-LK', { style:'currency', currency:'LKR', maximumFractionDigits:0 });
    const fmtDate = (iso) => new Date(iso + 'T00:00:00').toLocaleDateString(undefined,{ year:'numeric', month:'short', day:'2-digit' });
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
    function monthKey(d){ const dt = new Date(d + 'T00:00:00'); return dt.getFullYear() + '-' + String(dt.getMonth()+1).padStart(2,'0'); }
    function isInMonth(iso, yymm){ return monthKey(iso) === yymm; }

    function ensureCategoryOptions(){ document.getElementById('exCategory').innerHTML = CATEGORIES.map(c=>`<option>${c}</option>`).join(''); }
    function setMonthPickerToToday(){ const mp = document.getElementById('monthPicker'); const now = new Date(); mp.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; }

    // ------------------ Add Forms ------------------
    function initForms(){
      const exForm = document.getElementById('expenseForm'); document.getElementById('exDate').valueAsDate = new Date();
      exForm.addEventListener('submit', (e)=>{ e.preventDefault();
        const amt = Number(document.getElementById('exAmount').value||0);
        const date = document.getElementById('exDate').value; const cat = document.getElementById('exCategory').value;
        const method = document.getElementById('exMethod').value; const note = document.getElementById('exNote').value.trim(); if(!date||amt<=0) return;
        state.transactions.unshift({ id:uid(), type:'expense', date, note, category:cat, method, currency:'LKR', amount:amt, lkrAmount:amt, usdRateUsed:null }); save(); exForm.reset(); document.getElementById('exDate').valueAsDate = new Date(); refreshAll(); });

      const erForm = document.getElementById('earningForm'); document.getElementById('erDate').valueAsDate = new Date();
      erForm.addEventListener('submit', (e)=>{ e.preventDefault();
        const amt = Number(document.getElementById('erAmount').value||0); const cur = document.getElementById('erCurrency').value;
        const src = document.getElementById('erSource').value; const date = document.getElementById('erDate').value; const note = document.getElementById('erNote').value.trim(); if(!date||amt<=0) return;
        let lkrAmount = amt; let rateUsed = null; if(cur==='USD'){ rateUsed = Number(state.settings.usdLkrRate||0) || 1; lkrAmount = amt*rateUsed; }
        state.transactions.unshift({ id:uid(), type:'earning', date, note, source:src, method:null, currency:cur, amount:amt, lkrAmount:Math.round(lkrAmount), usdRateUsed:rateUsed }); save(); erForm.reset(); document.getElementById('erDate').valueAsDate=new Date(); refreshAll(); });
    }

    // ------------------ Dashboard ------------------
    function computeMonth(statsMonth){
      const list = state.transactions.filter(t=> isInMonth(t.date, statsMonth));
      const earnings = list.filter(t=>t.type==='earning').reduce((s,t)=>s+(t.lkrAmount||0),0);
      const expenses = list.filter(t=>t.type==='expense').reduce((s,t)=>s+(t.lkrAmount||0),0);
      const net = earnings-expenses;
      const ccSpend = list.filter(t=>t.type==='expense' && t.method==='Credit Card').reduce((s,t)=>s+(t.lkrAmount||0),0);
      return { list, earnings, expenses, net, ccSpend };
    }
    function renderKpis(stats){
      document.getElementById('kpiEarnings').textContent = fmtLKR.format(stats.earnings);
      document.getElementById('kpiExpenses').textContent = fmtLKR.format(stats.expenses);
      const netEl = document.getElementById('kpiNet'); netEl.textContent = fmtLKR.format(stats.net); netEl.style.color = stats.net < 0 ? '#fecaca' : '#bbf7d0';
      const limit = Number(state.settings.ccLimit||0) || 1; const pct = Math.min(100, Math.round((stats.ccSpend/limit)*100));
      document.getElementById('ccBar').style.width = pct + '%'; document.getElementById('ccSpendLbl').textContent = `${fmtLKR.format(stats.ccSpend)} spent`;
      document.getElementById('ccLimitLbl').textContent = `${fmtLKR.format(limit)} limit · ${pct}%`;
    }
    function renderRecent(stats){
      const recentWrap = document.getElementById('recent'); recentWrap.innerHTML=''; const tpl = document.getElementById('recentItemTpl');
      stats.list.slice(0,6).forEach(t=>{ const node = tpl.content.cloneNode(true); node.querySelector('.pill').classList.add(t.type);
        node.querySelector('.pill').textContent = t.type.toUpperCase(); node.querySelector('[data-date]').textContent = fmtDate(t.date);
        const title = t.type==='expense' ? `${t.category}${t.method? ' · '+t.method:''}` : `${t.source}${t.currency? ' · '+t.currency:''}`;
        node.querySelector('[data-title]').textContent = title + (t.note? ' — '+t.note: ''); node.querySelector('[data-amount]').textContent = fmtLKR.format(t.lkrAmount||0);
        recentWrap.appendChild(node); }); if(stats.list.length===0){ recentWrap.innerHTML = '<div class="muted">No transactions in this month yet.</div>'; }
    }
    function renderDonut(stats){
      const catTotals = {}; CATEGORIES.forEach(c=> catTotals[c]=0);
      stats.list.filter(t=>t.type==='expense').forEach(t=>{ catTotals[t.category] = (catTotals[t.category]||0) + (t.lkrAmount||0); });
      const entries = Object.entries(catTotals).filter(([,v])=>v>0); const total = entries.reduce((s,[,v])=>s+v,0);
      const donut = document.getElementById('donut'); const center = document.getElementById('donutCenter'); const legend = document.getElementById('legend');
      if(total===0){ donut.style.background='conic-gradient(#1f2937 0 100%)'; center.textContent='No data'; legend.innerHTML=''; return; }
      let start=0, i=0; const parts=[]; legend.innerHTML='';
      entries.forEach(([name,val])=>{ const angle=(val/total)*360; const color=COLORS[i++%COLORS.length]; parts.push(`${color} ${start}deg ${start+angle}deg`); start+=angle; const item=document.createElement('div'); item.className='item'; item.innerHTML=`<span class="swatch" style="background:${color}"></span> <span>${name}</span> <span class="muted">${Math.round((val/total)*100)}%</span>`; legend.appendChild(item); });
      donut.style.background = `conic-gradient(${parts.join(',')})`; center.textContent = fmtLKR.format(total);
    }

    // ------------------ Table & Editing ------------------
    function renderTable(month){
      const tbody = document.getElementById('tableBody'); const q=(document.getElementById('searchBox').value||'').toLowerCase(); const type=document.getElementById('typeFilter').value;
      const rows = state.transactions.filter(t=>isInMonth(t.date, month)).filter(t=> type==='all'? true : (t.type===type)).filter(t=>{
        const hay=[t.note, t.category, t.source, t.method].filter(Boolean).join(' ').toLowerCase(); return hay.includes(q);
      }).sort((a,b)=> a.date<b.date?1: a.date>b.date? -1: 0);
      tbody.innerHTML=''; rows.forEach(t=>{ const tr=document.createElement('tr'); tr.innerHTML = `
        <td>${fmtDate(t.date)}</td>
        <td><span class="pill ${t.type}">${t.type.toUpperCase()}</span></td>
        <td>${t.type==='expense' ? t.category : t.source || ''}</td>
        <td><b>${fmtLKR.format(t.lkrAmount||0)}</b></td>
        <td>${t.currency ? `${t.amount.toLocaleString()} ${t.currency}${t.usdRateUsed? ` @${t.usdRateUsed}`:''}` : ''}</td>
        <td>${t.method||''}</td>
        <td>${t.note||''}</td>
        <td class="row-actions"><button class="btn secondary" data-edit="${t.id}">Edit</button> <button class="btn ghost" data-del="${t.id}">Delete</button></td>`; tbody.appendChild(tr); });
      if(rows.length===0){ tbody.innerHTML = `<tr><td colspan="8" class="muted" style="padding:20px">No transactions match.</td></tr>`; }
      tbody.querySelectorAll('[data-del]').forEach(btn=> btn.addEventListener('click', ()=>{ const id=btn.getAttribute('data-del'); const ix=state.transactions.findIndex(x=>x.id===id); if(ix>-1 && confirm('Delete this entry?')){ state.transactions.splice(ix,1); save(); refreshAll(); } }));
      tbody.querySelectorAll('[data-edit]').forEach(btn=> btn.addEventListener('click', ()=> startEdit(btn.getAttribute('data-edit')) ));
    }
    function startEdit(id){
      const t = state.transactions.find(x=>x.id===id); if(!t) return; const tbody=document.getElementById('tableBody'); const rows=Array.from(tbody.querySelectorAll('tr')); const row=rows.find(r=> r.querySelector(`[data-edit="${id}"]`)); if(!row) return;
      row.innerHTML = `
        <td><input type="date" value="${t.date}" id="edDate"></td>
        <td><span class="pill ${t.type}">${t.type.toUpperCase()}</span></td>
        <td>${t.type==='expense' ? `<select id="edCat">${CATEGORIES.map(c=>`<option ${c===t.category?'selected':''}>${c}</option>`).join('')}</select>` : `<select id="edSrc"><option ${t.source==='Salary'?'selected':''}>Salary</option><option ${t.source==='Freelance'?'selected':''}>Freelance</option><option ${t.source==='Other'?'selected':''}>Other</option></select>`}</td>
        <td><input type="number" id="edLkr" min="0" step="0.01" value="${t.lkrAmount}"></td>
        <td>${t.type==='earning' ? `<input type="text" id="edOrig" value="${t.amount} ${t.currency}${t.usdRateUsed? ' @'+t.usdRateUsed:''}">` : ''}</td>
        <td>${t.type==='expense' ? `<select id="edMethod"><option ${t.method==='Credit Card'?'selected':''}>Credit Card</option><option ${t.method==='Cash'?'selected':''}>Cash</option><option ${t.method==='Bank Transfer'?'selected':''}>Bank Transfer</option></select>` : ''}</td>
        <td><input type="text" id="edNote" value="${t.note||''}"></td>
        <td class="row-actions"><button class="btn" id="saveEd">Save</button> <button class="btn ghost" id="cancelEd">Cancel</button></td>`;
      row.querySelector('#cancelEd').addEventListener('click', ()=> renderTable(document.getElementById('monthPicker').value));
      row.querySelector('#saveEd').addEventListener('click', ()=>{
        const date=row.querySelector('#edDate').value; const lkr=Number(row.querySelector('#edLkr').value||0); const note=row.querySelector('#edNote').value.trim(); if(!date || lkr<0) return alert('Please enter valid values'); t.date=date; t.lkrAmount=lkr; t.note=note;
        if(t.type==='expense'){ t.category=row.querySelector('#edCat').value; t.method=row.querySelector('#edMethod').value; t.amount=lkr; t.currency='LKR'; t.usdRateUsed=null; }
        else { t.source=row.querySelector('#edSrc').value; const raw=row.querySelector('#edOrig').value.trim(); const m=raw.match(/([0-9]+(?:\.[0-9]+)?)\s*(USD|LKR)(?:\s*@\s*([0-9]+(?:\.[0-9]+)?))?/i); if(m){ const a=Number(m[1]); const cur=m[2].toUpperCase(); const r=m[3]? Number(m[3]) : (cur==='USD'? state.settings.usdLkrRate:1); t.amount=a; t.currency=cur; t.usdRateUsed=cur==='USD'? r:null; t.lkrAmount=Math.round(cur==='USD'? a*r : a);} }
        save(); refreshAll();
      });
    }

    // ------------------ Compare (MoM) ------------------
    function monthsListUnique(){ const set = new Set(state.transactions.map(t=> monthKey(t.date))); return Array.from(set).sort(); }
    function monthLabel(yymm){ const [y,m] = yymm.split('-').map(Number); const d=new Date(y, m-1, 1); return d.toLocaleDateString(undefined,{month:'short', year:'2-digit'}); }
    function computeSeries(nMonths){ const uniq=monthsListUnique(); const last=uniq.slice(-nMonths); return last.map(key=>{ const s=computeMonth(key); return {key, earnings:s.earnings, expenses:s.expenses, net:s.net, cc:s.ccSpend};}); }
    function renderCompare(){ const sel=document.getElementById('cmpMonths'); if(!sel) return; const n=Number(sel.value||6); const data=computeSeries(n);
      const svg=document.getElementById('cmpChart'); const legend=document.getElementById('cmpLegend'); const tbody=document.getElementById('cmpTable'); svg.innerHTML=''; legend.innerHTML=''; tbody.innerHTML=''; if(data.length===0) return;
      const W=900,H=320,PADL=60,PADB=30,PADT=20,PADR=10; svg.setAttribute('viewBox',`0 0 ${W} ${H}`);
      const maxVal=Math.max(1, ...data.flatMap(d=> [d.earnings, d.expenses, Math.abs(d.net)]) ); const y=v=> H-PADB - (v/maxVal)*(H-PADT-PADB); const xStep=(W-PADL-PADR)/Math.max(1,data.length); const barW=Math.min(28, xStep*0.35);
      const g=document.createElementNS('http://www.w3.org/2000/svg','g'); for(let i=0;i<=4;i++){ const val=(maxVal*i/4); const yy=y(val); const line=document.createElementNS('http://www.w3.org/2000/svg','line'); line.setAttribute('x1',PADL); line.setAttribute('x2',W-PADR); line.setAttribute('y1',yy); line.setAttribute('y2',yy); line.setAttribute('class','grid-line'); g.appendChild(line); const tx=document.createElementNS('http://www.w3.org/2000/svg','text'); tx.setAttribute('x',PADL-6); tx.setAttribute('y',yy+4); tx.setAttribute('text-anchor','end'); tx.setAttribute('class','tick'); tx.textContent=Math.round(val).toLocaleString(); g.appendChild(tx);} svg.appendChild(g);
      data.forEach((d,i)=>{ const cx=PADL + xStep*i + xStep/2; const eH=H-PADB - y(d.earnings); const xH=H-PADB - y(d.expenses);
        const be=document.createElementNS('http://www.w3.org/2000/svg','rect'); be.setAttribute('x',cx - barW - 4); be.setAttribute('y',y(d.earnings)); be.setAttribute('width',barW); be.setAttribute('height',eH); be.setAttribute('class','bar-earn'); svg.appendChild(be);
        const bx=document.createElementNS('http://www.w3.org/2000/svg','rect'); bx.setAttribute('x',cx + 4); bx.setAttribute('y',y(d.expenses)); bx.setAttribute('width',barW); bx.setAttribute('height',xH); bx.setAttribute('class','bar-exp'); svg.appendChild(bx);
        const tx=document.createElementNS('http://www.w3.org/2000/svg','text'); tx.setAttribute('x',cx); tx.setAttribute('y',H-10); tx.setAttribute('text-anchor','middle'); tx.setAttribute('class','tick'); tx.textContent=monthLabel(d.key); svg.appendChild(tx);
      });
      const pathPts = data.map((d,i)=>{ const cx=PADL + xStep*i + xStep/2; return `${i===0?'M':'L'} ${cx} ${y(Math.max(0,d.net))}`; }).join(' ');
      const path=document.createElementNS('http://www.w3.org/2000/svg','path'); path.setAttribute('d',pathPts); path.setAttribute('class','line-net'); svg.appendChild(path);
      const mk=(color,label)=>{ const div=document.createElement('div'); div.className='item'; div.innerHTML=`<span class="swatch" style="background:${color}"></span><span>${label}</span>`; legend.appendChild(div); };
      mk('#60a5fa','Earnings'); mk('#34d399','Expenses'); mk('#f59e0b','Net (line)');
      data.slice().reverse().forEach(d=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${monthLabel(d.key)}</td><td><b>${fmtLKR.format(d.earnings)}</b></td><td>${fmtLKR.format(d.expenses)}</td><td style="color:${d.net<0?'#fecaca':'#bbf7d0'}">${fmtLKR.format(d.net)}</td><td>${fmtLKR.format(d.cc)}</td>`; tbody.appendChild(tr); });
    }
    function initCompare(){ const sel=document.getElementById('cmpMonths'); if(sel){ sel.addEventListener('change', renderCompare); }}

    // ------------------ Tabs ------------------
    function initTabs(){ const tabs=document.querySelectorAll('nav.tabs button'); tabs.forEach(b=> b.addEventListener('click', ()=>{ tabs.forEach(x=>x.classList.remove('active')); b.classList.add('active'); const id=b.dataset.tab; document.querySelectorAll('.tab-panel').forEach(p=> p.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); if(id==='compare') renderCompare(); })); }

    // ------------------ Export / Import ------------------
    function exportJson(){ const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const a=document.createElement('a'); const now=new Date(); a.href=URL.createObjectURL(blob); a.download=`monthly-money-${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}.json`; a.click(); URL.revokeObjectURL(a.href); }
    function importJson(file){ const reader=new FileReader(); reader.onload=()=>{ try{ const data=JSON.parse(reader.result); if(!confirm('Replace all current data with the imported file?')) return; state.settings=data.settings||DEFAULTS.settings; state.transactions=Array.isArray(data.transactions)? data.transactions:[]; save(); refreshAll(); alert('Import successful.'); }catch{ alert('Invalid file.'); } }; reader.readAsText(file); }

    // ------------------ Settings ------------------
    function initSettings(){ document.getElementById('usdRate').value=state.settings.usdLkrRate; document.getElementById('ccLimit').value=state.settings.ccLimit; document.getElementById('settingsForm').addEventListener('submit',(e)=>{ e.preventDefault(); state.settings.usdLkrRate=Number(document.getElementById('usdRate').value||0)||state.settings.usdLkrRate; state.settings.ccLimit=Number(document.getElementById('ccLimit').value||0)||state.settings.ccLimit; save(); refreshAll(); }); document.getElementById('resetData').addEventListener('click', ()=>{ if(confirm('This will delete ALL transactions and reset settings. Proceed?')){ localStorage.removeItem(STORAGE_KEY); location.reload(); } }); const import1=document.getElementById('importFile'); const import2=document.getElementById('importFile2'); import1.addEventListener('change', e=> e.target.files[0] && importJson(e.target.files[0])); import2.addEventListener('change', e=> e.target.files[0] && importJson(e.target.files[0])); document.getElementById('exportBtn').addEventListener('click', exportJson); document.getElementById('exportBtn2').addEventListener('click', exportJson); }

    // ------------------ Wiring ------------------
    function refreshAll(){ const month=document.getElementById('monthPicker').value; const stats=computeMonth(month); renderKpis(stats); renderRecent(stats); renderDonut(stats); renderTable(month); renderCompare(); }
    function initFilters(){ document.getElementById('monthPicker').addEventListener('change', refreshAll); document.getElementById('searchBox').addEventListener('input', ()=> renderTable(document.getElementById('monthPicker').value)); document.getElementById('typeFilter').addEventListener('change', ()=> renderTable(document.getElementById('monthPicker').value)); }

    // ------------------ Bootstrap ------------------
    ensureCategoryOptions(); initTabs(); initForms(); initSettings(); initFilters(); setMonthPickerToToday(); initCompare(); refreshAll();
  </script>
</body>
</html>
